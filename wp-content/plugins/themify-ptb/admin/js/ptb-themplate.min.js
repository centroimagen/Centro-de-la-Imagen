var PTB;!function($,e,t,i){"use strict";PTB={prefix:"ptb_",template_type:!1,init:function(e){e=$.extend({prefix:this.prefix,template_type:this.template_type},e),this.prefix=e.prefix,this.template_type=e.template_type,this.Undelegate(),this.bindEvents()},Undelegate:function(){$(t).off("change click")},bindEvents:function(){this.SetupColors(),this.SelectGrid(),this.InitDraggable(),this.InitSortable(),this.Open(),this.AddRow(),this.Delete(),this.Save(),this.Validate(),this.ShowHideSeperator(),this.InitTMCE(),this.InitDefaultContent(),this.AddIcon(),this.DisableItems(),this.showHideOptions(),InitLanguageTabs(),$.event.trigger("PTB.template_load",this.template_type)},SelectGrid:function(){$(t).on("click","."+PTB.prefix+"column_select",function(e){e.preventDefault(),$(this).closest("."+PTB.prefix+"grid_list_wrapper").find("li.selected").removeClass("selected"),$(this).closest("li").addClass("selected");var t='"'+$(this).data("grid")+'"',t=JSON.parse(t).split(","),e=$(this).closest("."+PTB.prefix+"back_row"),i=e.find("."+PTB.prefix+"back_col"),r=(i.removeAttr("class").addClass(PTB.prefix+"back_col").hide(),e.find("."+PTB.prefix+"back_module")),n=t.length,e=r.length,a=n<e?Math.ceil(e/n):1,o=[];0<r.length&&0<(e=r.find(".wp-editor-area")).length&&"undefined"!=typeof tinymce&&e.each(function(){var e=$(this).attr("id");tinyMCEPreInit.mceInit[e]&&(o[e]=PTB.GetEditorContent(e))});for(var s,c=0;c<n;c++){var l=$(i[c]),p=PTB.prefix+"col"+t[c]+" "+PTB.prefix+"show_grid";if(l.attr("data-grid",t[c]),0===c&&(p+=" first"),0<r.length){var d=l.find("."+PTB.prefix+"module_holder").first();d.find("."+PTB.prefix+"back_module").remove();for(var f=0;f<a;f++){if(!r[f])break;d.append(r[f])}r.splice(0,a)}l.addClass(p).show()}for(s in o)tinyMCEPreInit.mceInit[s]&&(tinymce.execCommand("mceRemoveEditor",!1,s),$("#"+s).ptb_wp_editor(),tinymce.execCommand("mceAddEditor",!1,s),PTB.SetEditorContent(s,o[s]));PTB.DestroyInputColor(),PTB.SetInputColor($("#"+PTB.prefix+"row_wrapper").find("."+PTB.prefix+"color_picker")),$.event.trigger("PTB.template_select_grid",[PTB.template_type,t])}),0===$("."+PTB.prefix+"grid_list li.selected").length?$("."+PTB.prefix+"column_select").first().trigger("click"):($("."+PTB.prefix+"back_row_content ."+PTB.prefix+"back_col[data-grid]").show(),this.PlaceHoldDragger(),PTB.Unique($("#"+PTB.prefix+"row_wrapper ."+PTB.prefix+"active_module")),"undefined"!=typeof tinymce&&$("#"+PTB.prefix+"row_wrapper ."+PTB.prefix+"wp_editor").each(function(){var e=PTB.GenerateUnique();$(this).attr("id",e).ptb_wp_editor(),tinyMCEPreInit.mceInit[e]&&tinymce.execCommand("mceAddEditor",!1,e)}),PTB.SetInputColor($("#"+PTB.prefix+"row_wrapper").find("."+PTB.prefix+"color_picker")))},PlaceHoldDragger:function(){$("."+PTB.prefix+"module_holder").each(function(){var e=$(this).find("."+PTB.prefix+"empty_holder_text");0===$(this).find("."+PTB.prefix+"active_module").length?e.show():e.hide()})},equalHeight:function(e){var t,e=e.find("."+PTB.prefix+"back_col:visible");1<e.length&&(e.css("min-height","initial"),t=$(e[0]).height(),e.each(function(){$(this).height()>t&&(t=$(this).height())}),e.css("min-height",t))},InitDraggable:function(){$("."+PTB.prefix+"back_module_panel ."+PTB.prefix+"back_module").draggable({appendTo:"body",helper:"clone",revert:"invalid",snapMode:"inner",connectToSortable:"."+PTB.prefix+"module_holder",stop:function(e,t){var i=$(t.helper[0]);$.event.trigger("PTB.template_drag_start",[i,t,PTB.template_type]),PTB.Unique(i),"custom_text"==i.data("type")?i.find("textarea."+PTB.prefix+"wp_editor").each(function(){var e=PTB.GenerateUnique();$(this).attr("id",e),$("#"+e).ptb_wp_editor(),setTimeout(function(){$("#wp-"+e+"-wrap").find(".switch-html").trigger("click")},1200)}):PTB.SetInputColor(i.find("."+PTB.prefix+"color_picker")),i.addClass("ptb_expanded"),i.find("."+PTB.prefix+"toggle_module").trigger("click"),$.event.trigger("PTB.template_drag_end",[i,t,PTB.template_type])}})},InitSortable:function(){$("."+PTB.prefix+"module_holder").sortable({placeholder:PTB.prefix+"ui_state_highlight",items:"."+PTB.prefix+"back_module",handle:".ptb_back_module_top",connectWith:"."+PTB.prefix+"module_holder",cursor:"move",revert:100,sort:function(e,t){t=t.item.outerHeight();$("."+PTB.prefix+"module_holder ."+PTB.prefix+"ui_state_highlight").height(t)},receive:function(e,t){PTB.PlaceHoldDragger(),$(this).parent().find("."+PTB.prefix+"empty_holder_text").hide()},start:function(e,t){$(t.item).removeClass(PTB.prefix+"dragged")},stop:function(e,t){t=$(t.item);t.addClass(PTB.prefix+"dragged"),PTB.equalHeight(t.closest("."+PTB.prefix+"back_row")),"undefined"!=typeof tinymce&&t.find("textarea."+PTB.prefix+"wp_editor").each(function(){var e=$(this).attr("id");tinyMCEPreInit.mceInit[e]&&(tinymce.execCommand("mceRemoveEditor",!1,e),tinymce.execCommand("mceAddEditor",!1,e),PTB.ActiveEdiror(e))})}}),$("#"+PTB.prefix+"row_wrapper").sortable({items:"."+PTB.prefix+"back_row",handle:"."+PTB.prefix+"back_row_top",axis:"y",placeholder:PTB.prefix+"ui_state_highlight",sort:function(e,t){t=t.item.height();$("#"+PTB.prefix+"row_wrapper ."+PTB.prefix+"ui_state_highlight").height(t)}})},Open:function(){$(t).on("click","."+PTB.prefix+"toggle_module,."+PTB.prefix+"toggle_row",function(e){var t=0===$(this).closest("."+PTB.prefix+"active_module").length?$(this).closest("."+PTB.prefix+"back_row").find("."+PTB.prefix+"back_row_content"):$(this).closest("."+PTB.prefix+"active_module").find("."+PTB.prefix+"back_active_module_content"),i=t.closest("."+PTB.prefix+"back_module."+PTB.prefix+"dragged,."+PTB.prefix+"back_row"),r=t.closest("."+PTB.prefix+"back_col"),n="."+PTB.prefix+'back_col[data-grid][class~="'+PTB.prefix+'back_col"][class*="'+PTB.prefix+'col"]';$(this).hasClass(PTB.prefix+"opened")||t.is(":visible")?($(this).removeClass(PTB.prefix+"opened"),i.removeClass(PTB.prefix+"expanded"),0<r.length&&0==r.find("."+PTB.prefix+"opened").length?r.removeClass("shadow",200,function(){t.slideUp(200,function(){r.removeClass("fill",200,"swing",function(){r.removeClass("fill"),r.siblings(n).show(200),$("."+PTB.prefix+"module_holder").sortable("enable")})})}):t.slideUp()):($(this).addClass(PTB.prefix+"opened"),i.addClass(PTB.prefix+"expanded"),0<r.length&&0!==r.siblings(n).length?r.siblings(n).hide(200,function(){r.addClass("fill"),t.slideDown(200,function(){r.addClass("shadow"),$("."+PTB.prefix+"module_holder").sortable("disable")})}):t.slideDown()),e.preventDefault()})},Delete:function(){$(t).on("click","."+PTB.prefix+"delete_module",function(e){var t,i;confirm(ptb_js_admin.module_delete)&&(i=(t=0===$(this).closest("."+PTB.prefix+"active_module").length?$(this).closest("."+PTB.prefix+"back_row"):$(this).closest("."+PTB.prefix+"back_module")).closest("."+PTB.prefix+"back_row"),t.remove(),0<i.length)&&(PTB.PlaceHoldDragger(),PTB.equalHeight(i)),e.preventDefault()})},AddRow:function(){$("."+PTB.prefix+"add_row").click(function(e){var t=$("."+PTB.prefix+"first_row").first().clone();t.removeClass(PTB.prefix+"first_row").find("."+PTB.prefix+"back_module").remove(),t.addClass("ptb_expanded").find(".ptb_back_row_content").show().prev().find(".ptb_toggle_module").addClass("ptb_opened"),t.find("."+PTB.prefix+"empty_holder_text").show(),t.find("."+PTB.prefix+"row_custom_css ").val(""),t.find("."+PTB.prefix+"back_col").css("min-height","initial"),$("."+PTB.prefix+"back_row").last().after(t),t.find("."+PTB.prefix+"column_select").first().trigger("click"),e.preventDefault(),PTB.InitSortable()})},Save:function(){$("#"+PTB.prefix+"submit").click(function(e){var t=$(this).closest("form"),i=$("."+PTB.prefix+"back_builder").find("input,select,textarea");i.attr("disabled","disabled"),setTimeout(function(){var e=PTB.ParseData(),e=($.event.trigger("PTB.before_template_save",e),JSON.stringify(e));$("#"+PTB.prefix+"layout").val(e),$.ajax({url:t.attr("action"),method:"POST",dataType:"json",data:t.serialize(),beforeSend:function(){t.addClass(PTB.prefix+"wait")},complete:function(){i.removeAttr("disabled"),t.removeClass(PTB.prefix+"wait")},success:function(e){e&&"1"==e.status&&($("#"+PTB.prefix+"success_text").addClass("ptb_success"),setTimeout(function(){$("#"+PTB.prefix+"success_text").removeClass("ptb_success")},2e3),$.event.trigger("PTB.after_template_save"))}})},0),e.preventDefault()})},Validate:function(){var t=$('input[name="'+PTB.prefix+'ptt_offset_post"]');t.keypress(function(e){e=e.which||e.keyCode;return!(46!==e&&31<e&&(e<48||57<e))}),$('input[name="'+PTB.prefix+'ptt_pagination_post"]').change(function(e){0==$(this).val()?t.attr("disabled","disabled"):t.removeAttr("disabled")}),$('input[name="'+PTB.prefix+'ptt_pagination_post"]:checked').trigger("change")},ParseData:function(){var e=$("#"+PTB.prefix+"row_wrapper").find("."+PTB.prefix+"back_row"),l={};return e.each(function(c){l[c]={},l[c].row_classes=$.trim($(this).find("."+PTB.prefix+"row_custom_css").val()),$(this).find("."+PTB.prefix+"show_grid").each(function(e){var s=$(this).attr("data-grid")+"-"+e;l[c][s]={},l[c][s].col_classes=$.trim($(this).find("."+PTB.prefix+"col_custom_css").val()),$(this).find("."+PTB.prefix+"back_active_module_content").each(function(a){var o=$(this).data("type"),e=(l[c][s][a]={},l[c][s][a].type=o,$(this).find('input:checked,input[type="text"],input[type="number"],input[type="hidden"],textarea,select'));e.length||(l[c][s][a].key=o),e.each(function(){var e=$(this).attr("name");if(e){var t=e.split("]");if(t){t.pop();var i,r=[];for(i in t){var n=t[i].split("[");n[1]&&(r[i]=n[1])}e="arr"===r[2],l[c][s][a].key=r[0],e||l[c][s][a][r[1]]&&!r[2]?e?(l[c][s][a][r[1]]=$(this).val(),l[c][s][a][r[1]]||(l[c][s][a][r[1]]=[])):("object"!=typeof l[c][s][a][r[0]]&&"object"!=typeof l[c][s][a][r[1]]&&(e=l[c][s][a][r[1]],l[c][s][a][r[1]]=[],l[c][s][a][r[1]][0]=e),l[c][s][a][r[1]].push($(this).val())):r[2]?(e=r[2],"object"!=typeof l[c][s][a][r[1]]&&(l[c][s][a][r[1]]={}),l[c][s][a][r[1]][e]="custom_text"!==o?$(this).val():PTB.GetEditorContent($(this).attr("id"))):(e=!1,e=$(this).hasClass(PTB.prefix+"color_picker")?"rgba(0, 0, 0, 1)"!==(e=$(this).minicolors("rgbaString"))&&e:"on"===$(this).val()||$(this).val(),l[c][s][a][r[1]]=e)}}})})})}),l},Unique:function(e){e.each(function(){var e,i=$(this),t=(i.find("label").each(function(){var e,t=$(this).attr("for");t&&(t=PTB.Escape($(this).attr("for")),0<$("#"+t).length)&&(e=PTB.GenerateUnique(),i.find("#"+t).attr("id",e),$(this).attr("for",e))}),/.*?\[(.+?)\]/gi),r=i.find('input[type="radio"]'),n={};for(e in r.each(function(e){var t=$(this).attr("name");t&&(n[t]=1)}),n){var a,o,s=e.match(t);s&&(o=PTB.GenerateUnique(),a=i.find('input:radio[name="'+e+'"]'),o=o+s[0]+s[1],a.attr("name",o),i.find('input:radio[name!="'+e+'"]'))&&i.find('input:radio[name="'+o+'"][checked]').prop("checked",!0)}})},DisableItems:function(){$(t).on("change",'.ptb_change_disable input[type="radio"],.ptb_change_disable input[type="checkbox"],.ptb_change_disable select',function(){var e,t,i,r,n=$(this).closest(".ptb_change_disable").data("disabled");!n&&"0"!=n||(n=n.toString().split(","),$.isArray(n)||(n=[n]),e=$(this).is(":checkbox")||$(this).is(":radio")?$(this).is(":checked"):1,t=$(this).is(":checkbox")&&1===$(this).closest(".ptb_back_active_module_input").find('input[type="checkbox"]').length?e?"0":"1":$(this).val(),i=$(this).closest(".ptb_change_disable").data("action"),r=(0<$(this).closest(".ptb_lightbox_row").length?$(this).closest(".ptb_lightbox_row_wrapper"):$(this).closest(".ptb_back_active_module_content")).find(".ptb_maybe_disabled"),1===$(this).closest(".ptb_back_active_module_input").find('input[type="checkbox"]').length&&(e=!e),i?-1!==$.inArray(t,n)&&e?r.hide():r.show():r.prop("disabled",e))}),$('.ptb_change_disable input[type="radio"]:checked,.ptb_change_disable input[type="checkbox"]:checked,.ptb_change_disable select option:selected').trigger("change")},showHideOptions:function(){$(t).on("change",'.ptb_thousand_separator input[type="text"]',function(){$(this).closest(".ptb_back_active_module_row").nextAll(":lt(2)").toggle(""!==this.value)}),$('.ptb_thousand_separator input[type="text"]').trigger("change")},GenerateUnique:function(){return PTB.prefix+Math.random().toString(36).substr(2,9)},Escape:function(e){return e.replace(/(:|\.|\[|\]|,)/g,"\\$1")},GetEditorContent:function(e){return"undefined"!=typeof tinymce&&$("#wp-"+e+"-wrap").hasClass("tmce-active")?tinyMCE.get(e).getContent():$("#"+e).val()},SetEditorContent:function(e,t){t=t||"","undefined"!=typeof tinymce&&tinymce.get(e).setContent(t),$("#"+e).val(t)},ActiveEdiror:function(e){e=$("#wp-"+e+"-wrap");(e.hasClass("html-active")?e.find(".switch-html"):e.find(".switch-tmce")).trigger("click")},ImageUpload:function(t){var i=wp.media.frames.file_frame=wp.media({title:$(this).data("uploader_title"),button:{text:$(this).data("uploader_button_text")},library:{type:"image"},multiple:!1});i.on("select",function(){var e=i.state().get("selection").first().toJSON();$(t).prev().val(e.url),$(t).closest(".ptb_post_image_wrapper").find(".ptb_post_image_thumb").css("background-image","url("+e.url+")")}),i.open()},ShowHideSeperator:function(){$(t).on("change","."+PTB.prefix+"back_text input:radio",function(){var e=$(this).closest("."+PTB.prefix+"back_active_module_row").next("div");"one_line"===$(this).val()?e.slideDown():e.slideUp()}),$("."+PTB.prefix+"back_text input:radio:checked").trigger("change")},InitTMCE:function(){setTimeout(function(){$(".switch-html").trigger("click")},1200)},InitDefaultContent:function(){var e,t;0<$("."+PTB.prefix+"new-themplate").length&&(e=$("#"+PTB.prefix+"cmb_title").clone(),t=$("#"+PTB.prefix+"cmb_editor").clone(),$("."+PTB.prefix+"back_col.first ."+PTB.prefix+"module_holder").append(e).append(t).find("."+PTB.prefix+"empty_holder_text").hide())},SetupColors:function(){$("#"+PTB.prefix+"row_wrapper").find("."+PTB.prefix+"color_picker").each(function(){var e=PTB.RgbaToHex($(this).data("value"));e&&-1!==e.indexOf("@")&&(e=e.split("@"),$(this).val(e[0]),$(this).attr("data-opacity",e[1]))})},SetInputColor:function(e){(e=e||$("."+PTB.prefix+"color_picker")).minicolors({opacity:!0,position:"top right",theme:"default",show:function(){$("."+PTB.prefix+"module_holder").sortable("disable")},hide:function(){$("."+PTB.prefix+"module_holder").sortable("enable")},create:function(e){}})},DestroyInputColor:function(){$("#"+PTB.prefix+"row_wrapper").find("."+PTB.prefix+"color_picker").minicolors("destroy")},RgbaToHex:function(e){var t;return!!e&&((t=(e=e.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(.*)[\s+]?\)/i))&&3<=e.length?"#"+("0"+parseInt(e[1],10).toString(16)).slice(-2)+("0"+parseInt(e[2],10).toString(16)).slice(-2)+("0"+parseInt(e[3],10).toString(16)).slice(-2):"")&&e[4]&&(t+="@"+e[4]),t)},AddIcon:function(){$(t).on("click",".ptb-icons-list a",function(e){e.preventDefault();var e=$("#ptb_row_wrapper .ptb_current_ajax"),t=$(this).data("icon");e.prev("input").val(t),$(this).closest(".ptb_admin_lightbox").find(".ptb_close_lightbox").trigger("click")})}}}(jQuery,window,document);